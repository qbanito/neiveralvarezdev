<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNIA CRM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #0f172a;
            color: #f8fafc;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìä OMNIA CRM Dashboard</h1>
            <p class="text-slate-400">Sistema de gesti√≥n de leads en tiempo real</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-slate-900 rounded-lg p-6 border border-slate-800">
                <div class="text-slate-400 text-sm mb-2">Total Leads</div>
                <div class="text-3xl font-bold text-white" id="totalLeads">0</div>
            </div>
            <div class="bg-slate-900 rounded-lg p-6 border border-slate-800">
                <div class="text-slate-400 text-sm mb-2">Nuevos</div>
                <div class="text-3xl font-bold text-cyan-400" id="newLeads">0</div>
            </div>
            <div class="bg-slate-900 rounded-lg p-6 border border-slate-800">
                <div class="text-slate-400 text-sm mb-2">Contactados</div>
                <div class="text-3xl font-bold text-blue-400" id="contactedLeads">0</div>
            </div>
            <div class="bg-slate-900 rounded-lg p-6 border border-slate-800">
                <div class="text-slate-400 text-sm mb-2">Ganados</div>
                <div class="text-3xl font-bold text-green-400" id="wonLeads">0</div>
            </div>
        </div>

        <div class="bg-slate-900 rounded-lg border border-slate-800 overflow-hidden">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Leads Recientes</h2>
                <button onclick="loadLeads()" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-colors">
                    üîÑ Recargar
                </button>
            </div>
            <div id="leadsContainer" class="divide-y divide-slate-800">
                <div class="p-8 text-center text-slate-500">
                    Cargando leads...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';

        async function loadLeads() {
            try {
                const response = await fetch(`${API_URL}/api/leads`);
                const data = await response.json();
                
                // Actualizar estad√≠sticas
                document.getElementById('totalLeads').textContent = data.total;
                
                const newCount = data.leads.filter(l => l.status === 'new').length;
                const contactedCount = data.leads.filter(l => l.status === 'contacted' || l.status === 'qualified' || l.status === 'proposal').length;
                const wonCount = data.leads.filter(l => l.status === 'won').length;
                
                document.getElementById('newLeads').textContent = newCount;
                document.getElementById('contactedLeads').textContent = contactedCount;
                document.getElementById('wonLeads').textContent = wonCount;

                // Renderizar leads
                const container = document.getElementById('leadsContainer');
                
                if (data.leads.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-slate-500">No hay leads todav√≠a</div>';
                    return;
                }

                container.innerHTML = data.leads.map(lead => {
                    const statusColors = {
                        'new': 'bg-cyan-500/20 text-cyan-400 border-cyan-500/50',
                        'contacted': 'bg-blue-500/20 text-blue-400 border-blue-500/50',
                        'qualified': 'bg-purple-500/20 text-purple-400 border-purple-500/50',
                        'proposal': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50',
                        'won': 'bg-green-500/20 text-green-400 border-green-500/50',
                        'lost': 'bg-red-500/20 text-red-400 border-red-500/50'
                    };

                    const statusColor = statusColors[lead.status] || statusColors.new;
                    const date = new Date(lead.createdAt).toLocaleString('es-ES');

                    return `
                        <div class="p-6 hover:bg-slate-800/50 transition-colors">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-white">${lead.name}</h3>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full border ${statusColor}">
                                            ${lead.status.toUpperCase()}
                                        </span>
                                    </div>
                                    <div class="text-sm text-slate-400 space-y-1">
                                        <div>üìß <a href="mailto:${lead.email}" class="hover:text-cyan-400">${lead.email}</a></div>
                                        ${lead.company ? `<div>üè¢ ${lead.company}</div>` : ''}
                                        ${lead.service ? `<div>üéØ ${lead.service}</div>` : ''}
                                        ${lead.budget ? `<div>üí∞ ${lead.budget}</div>` : ''}
                                        <div>üìÖ ${date}</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <select 
                                        onchange="updateStatus(${lead.id}, this.value)"
                                        class="px-3 py-1 bg-slate-800 border border-slate-700 rounded text-sm text-white focus:border-cyan-500 focus:outline-none"
                                    >
                                        <option value="new" ${lead.status === 'new' ? 'selected' : ''}>Nuevo</option>
                                        <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contactado</option>
                                        <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Calificado</option>
                                        <option value="proposal" ${lead.status === 'proposal' ? 'selected' : ''}>Propuesta</option>
                                        <option value="won" ${lead.status === 'won' ? 'selected' : ''}>Ganado</option>
                                        <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Perdido</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bg-slate-950/50 rounded-lg p-4 border border-slate-800">
                                <div class="text-slate-300 text-sm whitespace-pre-wrap">${lead.message}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('leadsContainer').innerHTML = `
                    <div class="p-8 text-center text-red-400">
                        ‚ùå Error cargando leads. Aseg√∫rate de que el API est√© corriendo en ${API_URL}
                    </div>
                `;
            }
        }

        async function updateStatus(leadId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/leads/${leadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus }),
                });

                if (response.ok) {
                    console.log('‚úÖ Status actualizado');
                    loadLeads(); // Recargar
                } else {
                    console.error('Error updating status');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Cargar leads al inicio
        loadLeads();

        // Auto-refresh cada 10 segundos
        setInterval(loadLeads, 10000);
    </script>
</body>
</html>
